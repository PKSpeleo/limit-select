<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Limited Selection of Items with Unicode Support</title>
  <style>
  .item {
      margin-bottom: 5px;
  }

  .item input[type="text"] {
      margin-right: 10px;
  }
  </style>
</head>
<body>

<h1>Limited Selection of Items</h1>

<label for="maxSelect">Maximum number of selectable items:</label>
<input id="maxSelect" min="1" style="width: 50px;" type="number" value="2">

<h2>Items</h2>
<div id="itemsList">
  <!-- Items will be added here -->
</div>

<button id="addItemButton">Add Item</button>

<script>
const maxSelectInput = document.getElementById('maxSelect');
const itemsList = document.getElementById('itemsList');
const addItemButton = document.getElementById('addItemButton');
let itemCount = 0;
let selectedItems = [];
let itemsData = [];

// Functions to handle base64 encoding/decoding with Unicode support
function base64Encode(str) {
  const encoder = new TextEncoder();
  const bytes = encoder.encode(str);
  let binary = '';
  bytes.forEach((b) => binary += String.fromCharCode(b));
  return btoa(binary);
}

function base64Decode(str) {
  const binary = atob(str);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  const decoder = new TextDecoder();
  return decoder.decode(bytes);
}

function updateURL() {
  const state = {
    maxSelect: maxSelectInput.value,
    items: itemsData.map(item => ({
      name: item.nameInput.value,
      selected: item.checkbox.checked
    }))
  };
  const stateString = JSON.stringify(state);
  const encodedState = base64Encode(stateString);
  const newURL = window.location.origin + window.location.pathname + '?state=' + encodeURIComponent(encodedState);
  window.history.replaceState(null, '', newURL);
}

function createItem(name = '', selected = false) {
  itemCount++;
  const itemDiv = document.createElement('div');
  itemDiv.className = 'item';

  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.id = 'itemCheckbox' + itemCount;
  checkbox.checked = selected;
  checkbox.addEventListener('change', handleCheckboxChange);

  const textInput = document.createElement('input');
  textInput.type = 'text';
  textInput.value = name;
  textInput.placeholder = 'Item Name';
  textInput.addEventListener('input', updateURL);

  const removeButton = document.createElement('button');
  removeButton.textContent = 'Remove';
  removeButton.addEventListener('click', () => {
    if (checkbox.checked) {
      selectedItems = selectedItems.filter(id => id !== checkbox.id);
    }
    itemsData = itemsData.filter(item => item.checkbox !== checkbox);
    itemsList.removeChild(itemDiv);
    updateURL();
  });

  itemDiv.appendChild(checkbox);
  itemDiv.appendChild(textInput);
  itemDiv.appendChild(removeButton);
  itemsList.appendChild(itemDiv);

  if (checkbox.checked) {
    selectedItems.push(checkbox.id);
  }

  itemsData.push({
    checkbox: checkbox,
    nameInput: textInput
  });

  updateURL();
}

function handleCheckboxChange(event) {
  const maxSelect = parseInt(maxSelectInput.value);
  const checkbox = event.target;
  if (checkbox.checked) {
    selectedItems.push(checkbox.id);
    if (selectedItems.length > maxSelect) {
      const deselectId = selectedItems.shift();
      const deselectCheckbox = document.getElementById(deselectId);
      deselectCheckbox.checked = false;
    }
  } else {
    selectedItems = selectedItems.filter(id => id !== checkbox.id);
  }
  updateURL();
}

maxSelectInput.addEventListener('change', () => {
  // Deselect items if new max is less than the number of selected items
  const maxSelect = parseInt(maxSelectInput.value);
  while (selectedItems.length > maxSelect) {
    const deselectId = selectedItems.shift();
    const deselectCheckbox = document.getElementById(deselectId);
    deselectCheckbox.checked = false;
  }
  updateURL();
});

addItemButton.addEventListener('click', () => {
  createItem();
});

// Function to load state from URL
function loadStateFromURL() {
  const params = new URLSearchParams(window.location.search);
  const encodedState = params.get('state');
  if (encodedState) {
    try {
      const stateString = base64Decode(decodeURIComponent(encodedState));
      const state = JSON.parse(stateString);
      maxSelectInput.value = state.maxSelect;
      // Clear existing items
      itemsList.innerHTML = '';
      itemsData = [];
      selectedItems = [];
      itemCount = 0;
      state.items.forEach(item => {
        createItem(item.name, item.selected);
      });
      // Ensure selection limits are enforced after loading
      const maxSelect = parseInt(maxSelectInput.value);
      while (selectedItems.length > maxSelect) {
        const deselectId = selectedItems.shift();
        const deselectCheckbox = document.getElementById(deselectId);
        deselectCheckbox.checked = false;
      }
    } catch (e) {
      console.error('Failed to load state from URL:', e);
    }
  } else {
    // Initialize with a few items if no state is present
    createItem('Item 1');
    createItem('Item 2');
    createItem('Item 3');
  }
}

// Load state on page load
window.addEventListener('load', loadStateFromURL);
</script>

</body>
</html>
